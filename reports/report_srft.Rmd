---
title: "ERAS+ data-set at Salford"
author: "Pablo M. Rodriguez"
date: "`r Sys.Date()`"
output: pdf_document
subtitle: ''
---

```{r setup, include=FALSE, echo=FALSE, error=TRUE}
library(tint)
# invalidate cache when the package version changes
knitr::opts_chunk$set(tidy = FALSE, echo = FALSE, cache=FALSE, cache.extra = packageVersion('tint'), warning = FALSE, message = FALSE)
options(htmltools.dir.version = FALSE)
library(readr)
library(tidyverse)
library(stringr)
library(grid)
library(gridExtra)
library(lubridate)
library(readxl)
library(ggthemes)
library(survival)
library(survminer)
library(reshape2)
library(qualityTools)

Sys.setlocale("LC_ALL", "uk")
na_list <- c(
  0, "0", "", "NA", "na", "n/a", "<NA>", "not known/not recorded",
  "not measured", "Not Measured", "none measured", "None Measured", "not done", "Not Done",
  "n/d", "Not Recorded", "not recorded", "u/k", "unknown"
)
data_path <- list.files(pattern = "\\.csv", full.names = TRUE, ignore.case = TRUE)[[1]]
df_srft <- read.csv(data_path, strip.white = TRUE, stringsAsFactors = FALSE, nrows = 280)
df_srft[, sapply(df_srft, is.character)] <- sapply(df_srft[, sapply(df_srft, is.character)],iconv, from = "WINDOWS-1252", to = "UTF-8")
df_srft[] <- lapply(df_srft, tolower)
df_srft[] <- lapply(df_srft, trimws)
# vectors with columns per timing
vars_pre <- c("troponin", "hb", "creatinine", "albumin", "tidal_vol", "chest_physio", "surgery_school", "date_school", 
              "school_satisfaction", "app_down", "website", "base_activity", "current_activity",
              "activity_type", "anaemia_treat", "anaesthesia", "area_surgery", "surgery", "surgeon", 
              "medical_hist", "smoke_hist", "smoke_cess", "asa_grade", "frailty", "cancer")
vars_2 <- c("inc_spiro", "t_brushes", "m_washes", "iv_disc", "drinking", "tolerate_15l",
            "oral_diet", "mobilised", "resp_supp", "elev_head")
vars_7 <- c("in_hospital", "location_7", "infec_24", "infec_7", "gastro", "pulm_supp_24", "pulm_supp_24", "pulm_pharm", "cardio_24", "troponin", "creatinine_base", "creatinine_high", "rrt", "renal_24", "neuro", "wound", "haemato", "pain",
            "mobility", "why_inpatient_7", "comment_7", "date_15", "inpatient_15", "comment_15", "discharge_date", "discharge_dest", "complication")
vars_adm <- c("age", "gender", "gm_eras_ele", "eras", "pqip_consent", "discharge_loc", "surgery_duration",
              "admission_date", "surgery_date", "discharge_date", "hospital_stay", "readmit_30", "days_readmit", "reason_readmit")


plotest <- function(dataFrame, na_values) {
        tempDf <- as.data.frame(lapply(dataFrame, function(x) ifelse(x %in% na_values, 0, 1)))
        tempDf <- tempDf[, order(colSums(tempDf))]
        tempData <- expand.grid(list(x = 1:nrow(tempDf), y = colnames(tempDf)))
        tempData$v <- as.vector(as.matrix(tempDf))
        tempData <- data.frame(x = unlist(tempData$x), y = unlist(tempData$y), v = unlist(tempData$v))
        ggplot(tempData) + geom_tile(aes(x=x, y=y, fill=factor(v))) +
                scale_fill_manual(values=c("white", "black"), name = "") +
                theme_light() + ylab(NULL) + xlab(NULL) + theme(legend.position = "none")
        
}
not_rec_list <- c("not known/not recorded", "n/r",
                  "not measured", "Not Measured", "none measured", "None Measured", "not done", "Not Done",
                  "n/d", "Not Recorded", "not recorded", "u/k", "unknown")

na_pure <- c(NA, 0, "0", "", "NA", "na", "n/a", "<NA>")
df_srft[] <- lapply(df_srft, function(x) ifelse(x %in% na_list, NA, x))
# Remove rows with empty values in all columns
rem_row <- function(x) {
  x[rowSums(is.na(x)) != ncol(x), ]
}
# Remove columns with empty values in all rows
rem_col <- function(x) {
  x[, colSums(is.na(x)) != nrow(x)]
}
df_srft <- rem_row(df_srft)
df_srft <- rem_col(df_srft)
df_srft <- rename(df_srft, comment_pre = comment)
# remove cancelled patients
df_srft <- df_srft[df_srft$comment_pre != "cancelled" | is.na(df_srft$comment_pre), ]
# Set fields types
df_srft$age <- as.numeric(df_srft$age)
df_srft$discharge_date <- as.Date(df_srft$discharge_date, format = "%d/%m/%Y")
df_srft$admission_date <- as.Date(df_srft$admission_date, format = "%d/%m/%Y")
df_srft$surgery_date <- as.Date(df_srft$surgery_date, format = "%d/%m/%Y")
df_srft$date_15 <- as.Date(df_srft$date_15, format = "%d/%m/%Y")
df_srft$date_school <- as.Date(df_srft$date_school, format = "%d/%m/%Y")
df_srft$surgery_duration <- lubridate::hms(df_srft$surgery_duration)
df_srft$surgery_duration <- lubridate::time_length(df_srft$surgery_duration, unit = "minutes")
df_srft$hospital_stay <- as.numeric(df_srft$hospital_stay)
df_srft$hospital_stay <- ifelse(df_srft$hospital_stay < 0, NA, df_srft$hospital_stay)
df_srft[] <- lapply(df_srft, function(x) {
  if (class(x) == "Date") {
    dplyr::if_else(lubridate::year(x) < 2018, as.Date(NA), x)
  }
  else {
    (x)
  }
})
df_srft$hb <- as.numeric(df_srft$hb)
# df_srft$creatinine <- sub(",", ".", df_srft$creatinine, fixed = TRUE)
df_srft$creatinine <- as.numeric(df_srft$creatinine)
# df_srft$albumin <- sub(",", ".", df_srft$albumin, fixed = TRUE)
df_srft$albumin <- as.numeric(df_srft$albumin)
# df_srft$creatinine_base <- sub(",", ".", df_srft$creatinine_base, fixed = TRUE)
df_srft$creatinine_base <- as.numeric(df_srft$creatinine_base)
# df_srft$creatinine_high <- sub(",", ".", df_srft$creatinine_high, fixed = TRUE)
df_srft$creatinine_high <- as.numeric(df_srft$creatinine_high)
# df_srft$creatinine_high <- sub(",", ".", df_srft$creatinine_high, fixed = TRUE)
df_srft$creatinine_high <- as.numeric(df_srft$creatinine_high)
# df_srft$troponin <- sub(",", ".", df_srft$troponin, fixed = TRUE)
df_srft$troponin <- sub("<", "-", df_srft$troponin)
df_srft$troponin <- as.numeric(df_srft$troponin)
# df_srft$troponin_7 <- sub(",", ".", df_srft$troponin_7, fixed = TRUE)
df_srft$troponin_7 <- sub("<", "-", df_srft$troponin_7, fixed = TRUE)
df_srft$troponin_7 <- as.numeric(df_srft$troponin_7)
# other fields
df_srft$discharge_loc <- sub("critical care (level 2)", "ccu (level 2)", df_srft$discharge_loc, fixed = TRUE)
df_srft$discharge_loc <- sub("ccu (level 2 and 3)", "ccu (level 2/3)", df_srft$discharge_loc, fixed = TRUE)
df_srft$discharge_loc <- str_replace(df_srft$discharge_loc, "^hdu$", "ccu")
# df_srft$current_activity <- sapply(strsplit(df_srft$current_activity, ","), `[`, 1)
df_srft$anaesthesia <- sapply(strsplit(df_srft$anaesthesia, ",\\s"), `[`, 1)
df_srft$surgeon <- gsub("/", ",", df_srft$surgeon, fixed = TRUE)
df_srft[df_srft$surgeon == "bilal khaffaf",]$surgeon <- "bilal alkhaffaf"
df_srft[df_srft$surgeon == "chaparala",]$surgeon <- "ramakrishna chaparala"
df_srft[df_srft$area_surgery == "urology",]$area_surgery <- "urology and endocrinology"
df_srft[df_srft$area_surgery == "nephrology",]$area_surgery <- "urology and endocrinology"
df_srft[df_srft$area_surgery == "endocrinology",]$area_surgery <- "urology and endocrinology"
df_srft[df_srft$area_surgery == "head and neck",]$area_surgery <- "other"
df_srft[df_srft$surgery == "adrenalectomy (unilateral)",]$surgery <- "adrenalectomy"
df_srft[df_srft$surgery == "anterior resection of rectum",]$surgery <- "anterior resection"
df_srft[df_srft$surgery == "cystoscopy, stents laparotomy, adhesiolysis, small bowel resection, formation of ileostomy, abdominal wall reconstruction",]$surgery <- "abdominal wall reconstruction"
df_srft[df_srft$surgery == "gastrectomy (partial / total) with excision of surrounding tissue",]$surgery <- "gastrectomy (total or partial) with excision of surrounding tissue"
df_srft[df_srft$surgery == "ileo-caecal resection (with anastamosis or ileostomy formation)",]$surgery <- "ileocaecal resection"
df_srft[df_srft$surgery == "laparoscopic left hemicolectomy",]$surgery <- "left hemicolectomy (with anastomosis /colostomy)"
df_srft[df_srft$surgery == "laparoscopic left nephrectomy +/- open",]$surgery <- "nephrectomy (non-transplant)"
df_srft[df_srft$surgery == "left hemicolectomy (with colostomy)",]$surgery <- "left hemicolectomy (with anastomosis /colostomy)"
df_srft[df_srft$surgery == "left radical laparoscopic nephrectomy",]$surgery <- "nephrectomy (non-transplant)"
df_srft[df_srft$surgery == "nephrectomy and excision of perirenal tissue",]$surgery <- "nephrectomy (non-transplant)"
df_srft[df_srft$surgery == "oesophagectomy",]$surgery <- "oesophagectomy (partial /total)/oesophagogastrectomy"
df_srft[df_srft$surgery == "oesophagectomy (total)/oesophagogastrectomy",]$surgery <- "oesophagectomy (partial /total)/oesophagogastrectomy"
df_srft[df_srft$surgery == "open gastrectomy",]$surgery <- "gastrectomy (partial / total) with excision of
surrounding tissue"
df_srft[df_srft$surgery == "laparoscopic right radical nephrectomy",]$surgery <- "nephrectomy (non-transplant)"
df_srft[df_srft$surgery == "open partial nephrectomy",]$surgery <- "nephrectomy (non-transplant)"
df_srft[df_srft$surgery == "open right adrenalectomy",]$surgery <- "adrenalectomy"
df_srft[df_srft$surgery == "open right radical nephrectomy with lymphadenectomy",]$surgery <- "nephrectomy (non-transplant)"
df_srft[df_srft$surgery == "partial gastrectomy (+/- excision of surrounding tissue)",]$surgery <- "gastrectomy (partial / total) with excision of
surrounding tissue"
df_srft[df_srft$surgery == "percutaneous nephrolithotomy",]$surgery <- "percutaneous nephrolithotomy (including cystoscopy
and retrograde catheterisation)"
df_srft[df_srft$surgery == "right adrenalectomy",]$surgery <- "adrenalectomy"
df_srft[df_srft$surgery == "right hemicolectomy (with ileostomy)",]$surgery <- "right hemicolectomy (with anastomosis /colostomy)"
df_srft[df_srft$surgery == "subtotal gastrectomy",]$surgery <- "gastrectomy (partial / total) with excision of
surrounding tissue"
df_srft[df_srft$surgery == "gastrectomy (total or partial) with excision of surrounding tissue",]$surgery <- "gastrectomy (partial / total) with excision of
surrounding tissue"
df_srft$surgery <- sub("\\\n", " ", df_srft$surgery)
# df_srft[df_srft$surgery == "percutaneous nephrolithotomy (including cystoscopy\nand retrograde catheterisation)",]$surgery <- "percutaneous nephrolithotomy (including cystoscopy
# and retrograde catheterisation)"
df_srft[df_srft$surgery == "right hemicolectomy (with anastamosis)",]$surgery <- "right hemicolectomy (with anastomosis /colostomy)"
df_srft$tidal_vol <- as.numeric(df_srft$tidal_vol)
df_srft$infec_24 <- sub("\\?", "", df_srft$infec_24)
# df_srft$infec_24 <- ifelse(!is.na(df_srft$infec_24) & df_srft$infec_24 == "patient had temperature >38c, patient currently on iv antibiotics", "patient currently on iv antibiotics, patient had temperature >38c", df_srft$infec_24)
df_srft$gastro <- ifelse(!is.na(df_srft$gastro) & df_srft$gastro == "experienced nausea, vomiting or distension, unable to tolerate enteral diet", "unable to tolerate enteral diet, experienced nausea, vomiting or distension", df_srft$gastro)
```
```{r}
df_srft$week_start <- cut.Date(df_srft$surgery_date, breaks = "week")
table_weeks <- transform(table(df_srft$week_start))
table_weeks$Var1 <- as.Date(table_weeks$Var1, format = "%Y-%m-%d")
df_srft$monthyr_surg <- format(as.Date(df_srft$surgery_date), "%Y-%m")
df_srft$monthyr_disc <- format(as.Date(df_srft$discharge_date), "%Y-%m")
```

# ERAS audit data. Last recorded date of surgery: `r max(df_srft$surgery_date)`
## Proportion of patients that attended surgery school
```{r fig.fullwidth=TRUE, fig.width=10, fig.height=4}
df_srft %>%
    dplyr::select(chest_physio, week_start) %>%
    mutate(chest_physio = if_else(chest_physio %in% c("nurse", "surgery school", "doctor"), 1, 0)) %>%
    group_by(week_start) %>%
    summarise(school_prop = sum(chest_physio) / n()) %>%
    ggplot(data = ., aes(x = as.Date(week_start, format = "%Y-%m-%d"), y = school_prop)) +
    geom_line(colour = "#FF2700") +
    geom_point(size = 1) +
    scale_x_date(date_breaks = "1 week", date_labels = "%b-%d") +
    scale_y_continuous(limits = c(0, 1)) +
    theme_fivethirtyeight() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

## Readmission within 30 days (grouped by month of discharge)
```{r fig.fullwidth=TRUE, fig.width=10, fig.height=4}
df_srft$monthyr_disc <- format(as.Date(df_srft$discharge_date), "%Y-%m")


df_srft %>%
        dplyr::select(surgery_date, readmit_30, area_surgery, monthyr_disc) %>%
        na.omit() %>%
        group_by(monthyr_disc, readmit_30) %>%
        summarise(n = n()) %>%
        mutate(rel_freq = n / sum(n)) %>%
        ggplot(data = ., aes(x = monthyr_disc, y = rel_freq, fill = readmit_30)) +
        geom_col() +
        labs(
                fill = "Readmitted?",
                x = "", y= "") +
        theme_fivethirtyeight()
```

\newpage

## What proportion of patients who were still in hospital on day 7 had any infection by week? 
```{r fig.fullwidth=TRUE, fig.width=10, fig.height=4, fig.cap= "Total N of patients mentioned"}
compl_yes <- c("abdominal leak", "chest", "surgical site infection", "empirical", "urine")
df_srft %>% 
  dplyr::select(infec_7, week_start) %>% 
  filter(!is.na(infec_7)) %>%
  mutate(complication = if_else(infec_7 %in% compl_yes, 1, 0),
         week_start = as.Date(week_start, format = "%Y-%m-%d")) %>%
  group_by(week_start) %>% 
  summarise(n_pts = n(), freq_compl = sum(complication)/n(), n_compl = sum(complication)) %>% 
  ggplot(data = .,aes(x = week_start, y = freq_compl)) +
  geom_line(aes(group = 1), colour = "#FF2700") +
  scale_x_date(date_breaks = "1 week", date_labels = "%d-%b") +
  geom_point(size = 0.8) +
  geom_text(aes(label = n_pts), size = 3, vjust = 0, nudge_y = 0.05) +
  theme_fivethirtyeight() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1), text = element_text(size = 20))
```

\newpage


## Median LoS with median absolute deviation grouped by month of surgery
```{r fig.fullwidth=TRUE, fig.width=10, fig.height=4}
df_srft %>%
  dplyr::select(monthyr_surg, hospital_stay) %>%
  mutate(stay = hospital_stay) %>%
  na.omit() %>%
  group_by(monthyr_surg) %>%
  summarise(med_los = median(stay, na.rm = TRUE),
            mad_los = mad(stay, na.rm = TRUE)) %>%
  ggplot(data = ., aes(x = monthyr_surg, y = med_los)) +
  geom_col() +
  geom_errorbar(aes(x = monthyr_surg, ymin = med_los - mad_los, ymax = med_los + mad_los), 
                na.rm = TRUE,
                width = .08) +
  labs(
       caption = paste("Last D/C:", max(df_srft$discharge_date, na.rm = TRUE))) +
  theme_fivethirtyeight() +
  theme(text = element_text(size = 20))
```

 

\newpage

# ICough bundle compliance. Items measured in retrospect 2 days after surgery

## Proportion of patients compliant with iCough bundle within 24 hours day after surgery
```{r fig.fullwidth=TRUE, fig.width=10, fig.height=4}
bundle_yes <- c(">two", "once", "twice", "yes")
 df_srft %>%
    dplyr::select(inc_spiro, t_brushes, m_washes, oral_diet, mobilised, week_start) %>%
    filter(rowSums(is.na(dplyr::select(., 1:5))) < 4) %>%  # omit recent surgeries
    mutate_at(
      .vars = vars(1:5),
      .funs = function(x) {
        if_else(x %in% bundle_yes, 1, 0)
      }
    ) %>%
    mutate(compliant = rowSums(dplyr::select(., 1:5))) %>%
    mutate(
      compliant = if_else(compliant >= 4, "yes", "no")
    ) %>%
    group_by(week_start) %>%
    summarise(prop = sum(compliant == "yes") / n()) %>% 
    ggplot(data = ., aes(x = as.Date(week_start), y = prop)) +
    geom_line(colour = "#FF2700", group = 1) +
    geom_point(size = 1) +
    scale_x_date(date_breaks = "1 week", date_labels = "%b-%d") +
    scale_y_continuous(limits = c(0, 1)) +
    theme_fivethirtyeight() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

## Proportion of patients with teeth brushed twice within 24 hours after surgery
```{r fig.fullwidth=TRUE, fig.width=10, fig.height=4}
df_srft %>%
    dplyr::select(t_brushes, week_start) %>%
    na.omit() %>%
    mutate(t_brushed = if_else(t_brushes == "twice", 1, 0)) %>%
    group_by(week_start) %>%
    summarise(freq = sum(t_brushed) / n()) %>%
    ggplot(data = ., aes(x = as.Date(week_start), y = freq)) +
    geom_line(colour = "#FF2700", group = 1) +
    geom_point(size = 1) +
    scale_x_date(date_breaks = "1 week", date_labels = "%b-%d") +
    scale_y_continuous(limits = c(0, 1)) +
    theme_fivethirtyeight() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1), text = element_text(size = 20))
```
\newpage
## Proportion of patients mobilised within 24 hours after surgery
```{r fig.fullwidth=TRUE, fig.width=10, fig.height=4}
df_srft %>%
    dplyr::select(mobilised, week_start) %>%
    na.omit() %>%
    mutate(mobilised = if_else(mobilised == "yes", 1, 0)) %>%
    group_by(week_start) %>%
    summarise(freq = sum(mobilised) / n(), n_pts = n()) %>%
    ggplot(data = ., aes(x = as.Date(week_start), y = freq)) +
    geom_line(colour = "#FF2700", group = 1) +
    geom_point(size = 1) +
    scale_x_date(date_breaks = "1 week", date_labels = "%b-%d") +
    scale_y_continuous(limits = c(0, 1)) +
    geom_text(aes(label = n_pts), size = 3, vjust = 0.5, nudge_y = -0.05) +
    theme_fivethirtyeight() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1), text = element_text(size = 20))
```

## Proportion of patients who used incentive spirometer within 24 hours after surgery
```{r fig.fullwidth=TRUE, fig.width=10, fig.height=4}
 df_srft %>%
    dplyr::select(inc_spiro, week_start) %>%
    na.omit() %>%
    mutate(inc_spiro = if_else(inc_spiro %in% c("once", "twice", ">two"), 1, 0)) %>%
    group_by(week_start) %>%
    summarise(freq = sum(inc_spiro) / n()) %>%
    ggplot(data = ., aes(x = as.Date(week_start), y = freq)) +
    geom_line(colour = "#FF2700", group = 1) +
    geom_point(size = 1) +
    scale_x_date(date_breaks = "1 week", date_labels = "%b-%d") +
    scale_y_continuous(limits = c(0, 1)) +
    theme_fivethirtyeight() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1), text = element_text(size = 20))
```
\newpage
## Proportion of patients who used mouthwash twice within 24 hours after surgery
```{r fig.fullwidth=TRUE, fig.width=10, fig.height=4}
 df_srft %>%
    dplyr::select(m_washes, week_start) %>%
    na.omit() %>%
    mutate(m_washed = if_else(m_washes == "twice", 1, 0)) %>%
    group_by(week_start) %>%
    summarise(freq = sum(m_washed) / n()) %>%
    ggplot(data = ., aes(x = as.Date(week_start), y = freq)) +
    geom_line(colour = "#FF2700", group = 1) +
    geom_point(size = 1) +
    scale_x_date(date_breaks = "1 week", date_labels = "%b-%d") +
    scale_y_continuous(limits = c(0, 1)) +
    theme_fivethirtyeight() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1), text = element_text(size = 20))
```

## Proportion of patients who re-started oral diet within 24 hours after surgery
```{r fig.fullwidth=TRUE, fig.width=10, fig.height=4}
df_srft %>%
    dplyr::select(oral_diet, week_start) %>%
    na.omit() %>%
    mutate(oral_diet = if_else(oral_diet == "yes", 1, 0)) %>%
    group_by(week_start) %>%
    summarise(freq = sum(oral_diet) / n()) %>%
    ggplot(data = ., aes(x = as.Date(week_start), y = freq)) +
    geom_line(colour = "#FF2700", group = 1) +
    geom_point(size = 1) +
    scale_x_date(date_breaks = "1 week", date_labels = "%b-%d") +
    scale_y_continuous(limits = c(0, 1)) +
    theme_fivethirtyeight() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1), text = element_text(size = 20))
```

\newpage


# Other

## Surgeries per week
```{r fig.fullwidth=TRUE, fig.width=10, fig.height=5}
df_srft$week_start <- cut.Date(df_srft$surgery_date, breaks = "week")
table_weeks <- transform(table(df_srft$week_start))
table_weeks$Var1 <- as.Date(table_weeks$Var1, format = "%Y-%m-%d")

ggplot(data = table_weeks, aes(x = Var1, y = Freq)) + 
  geom_point(size = 0.5) +
  geom_line(aes(group = 1), colour = "#FF2700") +
  scale_y_continuous(limits = c(0, 20)) +
  scale_x_date(date_breaks = "1 week", date_labels = "%d-%b") +
  labs(caption = "Starting on monday") +
  theme_fivethirtyeight() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1), text = element_text(size = 20))
```

## Aggregated number of surgeries per day of the week

```{r fig.fullwidth=TRUE, fig.width=10, fig.height=4}
  df_srft %>% 
  mutate(day_week = lubridate::wday(df_srft$surgery_date, label = TRUE, week_start = 1)) %>% 
  ggplot(data = ., aes(x = day_week)) +
  geom_bar() +
  scale_y_continuous(limits = c(0, 80)) +
  labs(caption = paste("From", min(df_srft$surgery_date, na.rm = TRUE), "to", max(df_srft$surgery_date, na.rm = TRUE))) +
  theme_fivethirtyeight() +
  theme(text = element_text(size = 20))
```

\newpage
## Compliance with iCough by area. 
```{r fig.fullwidth=TRUE, fig.width=10, fig.height=9, fig.cap="Compliance is defined as completing at least 4 out of 5: diet, mouthwash, teeth brushing, diet, mobility, incentive spirometer"}
bundle_yes <- c(">two", "once", "twice", "yes")

df_srft %>%
  dplyr::select(inc_spiro, t_brushes, m_washes, oral_diet, mobilised) %>%
  sapply(., function(x) {
    if_else(x %in% bundle_yes, 1, 0)
  }) %>%
  as.data.frame(.) %>%
  mutate(compliant = rowSums(.)) %>%
  mutate(
    compliant = if_else(compliant >= 4, "yes", "no"),
    area_surgery = df_srft$area_surgery
  ) %>%
  ggplot(data = ., aes(x = compliant)) +
  stat_count() +
  theme_fivethirtyeight() +
  theme(text = element_text(size = 20)) +
  facet_wrap(vars(area_surgery), ncol = 2)
```
```{r fig.cap="Patients are grouped by specialty and by overall compliance (yes/no). Y-axis shows number of patients who complied with the given item in the X-axis: diet, incentive spirometer, mobility, mouth wash and teeth brushing", fig.fullwidth=TRUE, fig.width=15, fig.height=15}
df_srft %>%
  dplyr::select(inc_spiro, t_brushes, m_washes, oral_diet, mobilised) %>%
  sapply(., function(x) {
    if_else(x %in% bundle_yes, 1, 0)
  }) %>%
  as.data.frame(.) %>%
  mutate(compliant = rowSums(.)) %>%
  mutate(
    compliant = if_else(compliant >= 4, "yes", "no"),
    area_surgery = df_srft$area_surgery
  ) %>%
  rename(is = inc_spiro, tb = t_brushes, mob = mobilised, 
         mw = m_washes, diet = oral_diet) %>% 
  group_by(compliant, area_surgery) %>% 
  summarise_at(., .vars = 1:5, .funs = sum) %>% 
  gather(key, value, -compliant, -area_surgery) %>% 
  ggplot(data = .) + 
  geom_col(aes(x = key, y = value)) +
  facet_wrap(vars(area_surgery, compliant), scales = "free_x", ncol = 2) +
  theme_fivethirtyeight() +
  theme(text = element_text(size = 20), axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))
```
\newpage

## Aggregated length of stay
```{r fig.fullwidth=TRUE, fig.width=10, fig.height=5}
df_srft %>%
  dplyr::select(area_surgery, hospital_stay) %>%
  ggplot(data = .) +
  stat_bin(aes(x = hospital_stay), binwidth = 1) +
  scale_x_continuous(breaks = seq(min(df_srft$hospital_stay, na.rm = TRUE), max(df_srft$hospital_stay, na.rm = TRUE), 3)) +
  scale_y_continuous(limits = c(0, 30), breaks = seq(0, 25, 5)) +
  labs(
    caption = paste("Last D/C:", max(df_srft$discharge_date, na.rm = TRUE))
  ) +
  theme_fivethirtyeight() +
  theme(text = element_text(size = 20), axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))
```


## Median LoS with median absolute deviation per area
```{r fig.fullwidth=TRUE, fig.width=10, fig.height=4}
df_srft$area_surgery <- factor(df_srft$area_surgery)
levels(df_srft$area_surgery) <- gsub(" ", "\n", levels(df_srft$area_surgery))
df_srft %>% 
  dplyr::select(area_surgery, hospital_stay) %>%
  group_by(area_surgery) %>% 
  summarise(med_los = median(hospital_stay, na.rm = TRUE), 
            mad_los = mad(hospital_stay, na.rm = TRUE)) %>%
  ggplot(data = .) + 
  geom_col(aes(x = area_surgery, y = med_los)) +
  geom_errorbar(aes(x = area_surgery, ymin = med_los - mad_los, ymax = med_los + mad_los), 
                na.rm = TRUE,
                width = .08) +
  scale_y_continuous(limits = c(0, 20), breaks = seq(0, 20, 5)) +
  labs( 
       caption = paste("Last D/C:", max(df_srft$discharge_date, na.rm = TRUE))) +
  theme_fivethirtyeight() +
   theme(text = element_text(size = 20))
```

## LOS distribution per area
```{r fig.fullwidth=TRUE, fig.width=10, fig.height=13}
los_back <- subset(df_srft, select = -area_surgery)

ggplot(data = df_srft, aes(x = hospital_stay, fill = area_surgery)) +
  geom_histogram(colour = "black", binwidth = 1) +
  geom_histogram(data = los_back, fill = "grey", alpha = .5, binwidth = 1) +
  scale_x_continuous(breaks = seq(min(df_srft$hospital_stay, na.rm = TRUE), max(df_srft$hospital_stay, na.rm = TRUE), 3)) +
  labs(
    caption = paste("Last D/C:", max(df_srft$discharge_date, na.rm = TRUE))
  ) +
  facet_wrap(vars(area_surgery), ncol = 2, scales = "free_y") +
  theme_fivethirtyeight() +
  guides(fill = FALSE) +
  theme(text = element_text(size = 18), axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))
```
\newpage

## LOS (y axis) grouped by number of icough items complied with
```{r fig.fullwidth=TRUE, fig.width=10, fig.height=9}
df_srft %>% dplyr::select(inc_spiro, m_washes, t_brushes, oral_diet, mobilised, hospital_stay) %>% 
  mutate(inc_spiro = if_else(inc_spiro %in% bundle_yes, 1, 0),
         m_washes = if_else(m_washes == "twice", 1, 0),
         t_brushes = if_else(t_brushes == "twice", 1, 0),
         oral_diet = if_else(oral_diet == "yes", 1, 0),
         mobilised = if_else(mobilised == "yes", 1, 0)
  ) %>% 
  na.omit() %>% 
  mutate(compl_group = rowSums(dplyr::select(., 1:5))) %>%
  mutate_at(vars(compl_group), as.character) %>% 
  ggplot(., aes(y = hospital_stay, x = compl_group, colour = compl_group)) +
  scale_y_continuous(
    breaks = seq(min(df_srft$hospital_stay, na.rm = TRUE),
                 max(df_srft$hospital_stay, na.rm = TRUE), 3)) +
  geom_jitter(width = 0.25) +
  theme_fivethirtyeight() +
  labs(
       caption = paste("From", min(df_srft$surgery_date, na.rm = TRUE), "to", max(df_srft$surgery_date, na.rm = TRUE))) +
  theme(legend.position = "none",
        text = element_text(size = 25))
```
\newpage

## Same as above but area of surgery is given a colour
```{r fig.fullwidth=TRUE, fig.width=10, fig.height=9}
df_srft %>% dplyr::select(inc_spiro, m_washes, t_brushes, oral_diet, mobilised, hospital_stay, area_surgery) %>% 
  mutate(inc_spiro = if_else(inc_spiro %in% bundle_yes, 1, 0),
         m_washes = if_else(m_washes == "twice", 1, 0),
         t_brushes = if_else(t_brushes == "twice", 1, 0),
         oral_diet = if_else(oral_diet == "yes", 1, 0),
         mobilised = if_else(mobilised == "yes", 1, 0)
  ) %>% 
  na.omit() %>% 
  mutate(compl_group = rowSums(dplyr::select(., 1:5))) %>%
  mutate_at(vars(compl_group), as.character) %>% 
  ggplot(., aes(y = hospital_stay, x = compl_group, colour = area_surgery)) +
  scale_y_continuous(
    breaks = seq(min(df_srft$hospital_stay, na.rm = TRUE),
                 max(df_srft$hospital_stay, na.rm = TRUE), 3)) +
  geom_jitter(width = 0.25) +
  theme_fivethirtyeight() +
  labs(caption = paste("From", min(df_srft$surgery_date, na.rm = TRUE), "to", max(df_srft$surgery_date, na.rm = TRUE))) +
  theme(legend.position = "bottom",
        legend.direction = "horizontal",
        text = element_text(size = 25),
        legend.text = element_text(size = 15),
        legend.title = element_text(size = 15))

```

\newpage

## Day of the week of surgery and LoS
```{r fig.fullwidth=TRUE, fig.width=10, fig.height=5}
df_srft %>% 
  dplyr::select(surgery_date, 
                hospital_stay) %>% 
  mutate(day_week = lubridate::wday(surgery_date, label = TRUE, week_start = 1)) %>% 
  na.omit() %>% 
  ggplot(., aes(x = day_week, y = hospital_stay, colour = day_week)) +
  scale_y_continuous(
    breaks = seq(min(df_srft$hospital_stay, na.rm = TRUE),
                 max(df_srft$hospital_stay, na.rm = TRUE), 3)) +
  geom_jitter(width = 0.25) +
  theme_fivethirtyeight() +
   theme(legend.position = "none",
        text = element_text(size = 25)) +
  coord_flip()
  
```

## Infectious complications (y axis) within 7 days and LoS
```{r fig.fullwidth=TRUE, fig.width=10, fig.height=4}
compl_yes <- c("abdominal leak", "chest", "surgical site infection", "empirical", "urine")
df_srft %>% 
  dplyr::select(infec_7, hospital_stay) %>% 
  na.omit() %>% 
  mutate(complication = if_else(infec_7 %in% compl_yes, "yes", "no")) %>%
  ggplot(., aes(x = complication, y = hospital_stay)) +
  scale_y_continuous(
    breaks = seq(min(df_srft$hospital_stay, na.rm = TRUE),
                 max(df_srft$hospital_stay, na.rm = TRUE), 3)) +
  geom_jitter(width = 0.25) +
  theme_fivethirtyeight() +
  theme(text = element_text(size = 25)) +
  coord_flip()
  
```

\newpage




## Overall Kaplan-Meier estimate of probability of still being in hospital on a given day after surgery (y axis)
```{r fig.fullwidth=TRUE, fig.width=10, fig.height=5}
df_suv <- df_srft %>%
  dplyr::select(
    surgery_date, discharge_date,
    pulm_supp_24, infec_24, renal_24,
    gastro, cardio_24, neuro,
    haemato, wound, pain, area_surgery,
    inc_spiro, t_brushes, m_washes, oral_diet, mobilised
  ) %>%
  mutate_at(
    .vars = vars(13:17),
    .funs = function(x) {
      if_else(x %in% bundle_yes, 1, 0)
    }
  ) %>%
  mutate(compliant = rowSums(dplyr::select(., 13:17))) %>%
  mutate(
    compliant = factor(if_else(compliant >= 4, "yes", "no"))
  ) %>%
  mutate(
    discharge = if_else(!is.na(discharge_date), 1, 0),
    time_event = if_else(is.na(discharge_date) == TRUE, Sys.Date() - surgery_date, discharge_date - surgery_date)
  ) %>%
  mutate_at(
    .vars = vars(3:11),
    .funs = function(x)
      if_else(x == "none of the above" | is.na(x) == TRUE, 0, 1) ## pts d/c before 7 days are considered as no morb
  ) %>%
  mutate(poms = factor(if_else(rowSums(dplyr::select(., 3:11)) == 0, "no", "yes")))

los_km <- survfit(Surv(time = time_event, event = discharge) ~ 1, data = df_suv)

ggsurvplot(los_km,
           conf.int = TRUE,
           risk.table = F,
           legend = "none",
           surv.median.line = "hv",
           linetype = 1,
           palette = "lancet",
           break.x.by = 3,
           ggtheme = theme_fivethirtyeight()
)
```

## Number of morbidites according to POMS criteria (y axis)(administered on day 7) and LoS
```{r fig.fullwidth=TRUE, fig.width=10, fig.height=4}
df_srft %>%
  dplyr::select(
    pulm_supp_24, infec_24, renal_24, gastro, cardio_24, neuro,
    haemato, wound, pain, hospital_stay
  ) %>% 
  na.omit() %>%  ## there are pts with day 7 items completed and not d/c
  mutate_at(
    .vars = vars(-hospital_stay),
    .funs = function(x) 
      if_else(x == "none of the above", 0, 1)
    
  ) %>%
  mutate(morbid = rowSums(dplyr::select(., 1:9))) %>%
  ggplot(., aes(x = as.factor(morbid), y = hospital_stay, colour = as.factor(morbid))) +
  geom_jitter(width = 0.25) +
  scale_y_continuous(breaks = seq(min(df_srft$hospital_stay, na.rm = TRUE),
                                  max(df_srft$hospital_stay, na.rm = TRUE), 3)) +
  theme_fivethirtyeight() +
  theme(legend.position = "none",
        text = element_text(size = 25)) +
  coord_flip()
```

\newpage




## Kaplan-Meier grouped by POMS (yes/no) including patients discharged before day 7 as not showing any morbidity
```{r}
los_km_poms <- survfit(Surv(time = time_event, event = discharge) ~ poms, data = df_suv)
```

```{r fig.fullwidth=TRUE, fig.width=10, fig.height=5}
ggsurvplot(los_km_poms,
                               conf.int = TRUE,
                               risk.table = FALSE,
                               surv.median.line = "hv",
                               linetype = 1,
                               palette = "lancet",
                               break.x.by = 3,
                               ggtheme = theme_fivethirtyeight()
)

```

## Combined POMS and general curve
```{r fig.fullwidth=TRUE, fig.width=10, fig.height=4}
ggsurvplot_combine(list(poms = los_km_poms, general = los_km),
                   conf.int = TRUE,
                   data = df_suv,
                   surv.median.line = "hv",
                   linetype = 1,
                   palette = "lancet",
                   break.x.by = 3,
                   ggtheme = theme_fivethirtyeight()
)

```
\newpage

## Consider only cases where POMS was administered, this is, patients not discharged before day 7
```{r}
df_suv_7 <- df_srft %>%
  dplyr::select(
    surgery_date, discharge_date,
    pulm_supp_24, infec_24, renal_24,
    gastro, cardio_24, neuro,
    haemato, wound, pain
  ) %>%
  filter_at(vars(3:11), any_vars(!is.na(.))) %>%
  mutate(
    discharge = if_else(!is.na(discharge_date), 1, 0),
    time_event = if_else(is.na(discharge_date) == TRUE, Sys.Date() - surgery_date, discharge_date - surgery_date)
  ) %>%
  mutate_at(
    .vars = vars(3:11),
    .funs = function(x)
      if_else(x == "none of the above", 0, 1)
  ) %>% 
  mutate(poms = if_else(rowSums(dplyr::select(., 3:11)) == 0, "no", "yes"))

los_km_poms_7 <- survfit(Surv(time = time_event, event = discharge) ~ poms, data = df_suv_7)

```
```{r fig.fullwidth=TRUE, fig.width=10, fig.height=4}
ggsurvplot(los_km_poms_7,
                             conf.int = TRUE,
                             risk.table = FALSE,
                             surv.median.line = "hv",
                             linetype = 1,
                             palette = "lancet",
                             break.x.by = 3,
                             ggtheme = theme_fivethirtyeight()
)

```

## Grouped by compliance with iCough bundle
```{r fig.fullwidth=TRUE, fig.width=10, fig.height= 4}
df_suv_compl <- df_srft %>%
  dplyr::select(inc_spiro, t_brushes, m_washes, oral_diet, mobilised, discharge_date, surgery_date) %>%
  mutate(
    inc_spiro = dplyr::if_else(inc_spiro %in% c(">two", "twice", "once"), 1, 0),
    t_brushes = dplyr::if_else(t_brushes == "twice", 1, 0),
    m_washes = dplyr::if_else(m_washes == "twice", 1, 0),
    oral_diet = dplyr::if_else(oral_diet == "yes", 1, 0),
    mobilised = dplyr::if_else(mobilised == "yes", 1, 0)
  ) %>%
  mutate(compliant = rowSums(dplyr::select(., 1:5))) %>%
  mutate(
    compliant = factor(dplyr::if_else(compliant >= 4, "yes", "no"))
  ) %>%
  mutate(
    discharge = dplyr::if_else(!is.na(discharge_date) == TRUE, 1, 0),
    time_event = dplyr::if_else(is.na(discharge_date) == TRUE, Sys.Date() - surgery_date, discharge_date - surgery_date))

los_km_cough <- survfit(Surv(time = time_event, event = discharge) ~ compliant, data = df_suv) 
ggsurvplot(los_km_cough, 
conf.int = TRUE, 
  risk.table = FALSE, 
  surv.median.line = "hv", 
  linetype = 1,
  palette = "lancet", 
  break.x.by = 3, 
  ggtheme = theme_fivethirtyeight()) 

``` 
<!-- \newpage -->
<!-- ## Grouped by compliant using poms positive as strata (pts d/c before 7 days are considered as no morb) -->
<!-- ```{r fig.fullwidth=TRUE, fig.width=10, fig.height= 4} -->
<!-- compl_poms_temp <- survfit(Surv(time = time_event, event = discharge) ~ compliant + strata(poms), data = df_suv, type = "kaplan-meier") -->
<!-- ggsurvplot(compl_poms_temp, -->
<!--            conf.int = TRUE, -->
<!--            risk.table = FALSE, -->
<!--            surv.median.line = "hv", -->
<!--            linetype = 1, -->
<!--            palette = "lancet", -->
<!--            break.x.by = 3, -->
<!--            ggtheme = theme_fivethirtyeight() -->
<!-- ) -->
<!-- ``` -->


<!-- ## Same as above but considering only patients who were administered POMS -->
<!-- ```{r fig.fullwidth=TRUE, fig.width=10, fig.height= 4} -->
<!-- compl_poms_7 <- df_srft %>% -->
<!--   dplyr::select( -->
<!--     surgery_date, discharge_date, -->
<!--     pulm_supp_24, infec_24, renal_24, -->
<!--     gastro, cardio_24, neuro, -->
<!--     haemato, wound, pain, area_surgery, -->
<!--     inc_spiro, t_brushes, m_washes, oral_diet, mobilised -->
<!--   ) %>% -->
<!--   filter_at(vars(3:11), any_vars(!is.na(.))) %>% -->
<!--   mutate_at( -->
<!--     .vars = vars(13:17), -->
<!--     .funs = function(x) { -->
<!--       if_else(x %in% bundle_yes, 1, 0) -->
<!--     } -->
<!--   ) %>% -->
<!--   mutate(compliant = rowSums(dplyr::select(., 13:17))) %>% -->
<!--   mutate( -->
<!--     compliant = factor(if_else(compliant >= 4, "yes", "no")) -->
<!--   ) %>% -->
<!--   mutate( -->
<!--     discharge = if_else(!is.na(discharge_date), 1, 0), -->
<!--     time_event = if_else(is.na(discharge_date) == TRUE, Sys.Date() - surgery_date, discharge_date - surgery_date) -->
<!--   ) %>% -->
<!--   mutate_at( -->
<!--     .vars = vars(3:11), -->
<!--     .funs = function(x) -->
<!--       if_else(x == "none of the above", 0, 1) -->
<!--   ) %>% -->
<!--   mutate(poms = factor(if_else(rowSums(dplyr::select(., 3:11)) == 0, "no", "yes")))  -->

<!-- compl_poms_7_km <- survfit(Surv(time = time_event, event = discharge) ~ compliant + strata(poms), data = compl_poms_7, type = "kaplan-meier") -->


<!-- ggsurvplot(compl_poms_7_km, -->
<!--     conf.int = TRUE, -->
<!--     risk.table = FALSE, -->
<!--     surv.median.line = "hv", -->
<!--     linetype = 1, -->
<!--     palette = "lancet", -->
<!--     break.x.by = 3, -->
<!--     ggtheme = theme_fivethirtyeight() -->
<!--   ) -->
<!-- ``` -->

<!-- \newpage -->