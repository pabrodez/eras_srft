---
title: "Overview of colorectal baseline data"
author: "Pablo M. Rodriguez"
date: "`r format(Sys.Date(), '%d %m %Y')`"
output: 
  pdf_document: 
    highlight: tango
    fig_caption: yes
fontsize: 12pt
---

```{r chunk options, include = FALSE}
knitr::opts_chunk$set(tidy = FALSE, echo = FALSE, cache = FALSE, warning = FALSE, message = FALSE)
```

```{r libraries, include = FALSE}
library(tidyverse)
library(lubridate)
library(readxl)
library(survival)
library(survminer)
library(survMisc)
library(stringr)
library(ggthemes)
library(reshape2)
library(knitr)
library(kableExtra)
library(gridExtra)
library(survival)
library(survminer)
```

```{r read and clean eras dataset, include=FALSE}
# 1.1 Read data ---------------------------------------------------------------
# save "collated" sheet as a single .csv file and move manually to folder "data"
df_srft <- read.csv("./data/eras_srft.csv", strip.white = TRUE, stringsAsFactors = FALSE, nrow = 310) ## specify number of rows to read as excel tends to generate blank rows, slowing this step
df_srft[, sapply(df_srft, is.character)] <- sapply(df_srft[, sapply(df_srft, is.character)],
  iconv,
  from = "WINDOWS-1252", to = "UTF-8"
)
# 1.2 Data cleaning -----------------------------------------------------------
df_srft[] <- lapply(df_srft, function(x)
  if (is.character(x) == TRUE) {
    tolower(x)
  } else {
    x
  })
df_srft[] <- lapply(df_srft, function(x)
  if (is.character(x) == TRUE) {
    trimws(x)
  } else {
    x
  })
# Replace not recorded and missing values with NAs (to be discussed)
na_list <- c(
  0, "0", "", "NA", "na", "n/a", "<NA>", "not known/not recorded", "n/r",
  "not measured", "Not Measured", "none measured", "None Measured", "not done", "Not Done",
  "n/d", "Not Recorded", "not recorded", "u/k", "unknown", "#ref!"
)
df_srft[] <- lapply(df_srft, function(x) ifelse(x %in% na_list, NA, x))
# Remove rows with empty values in all columns
remove_blankr <- function(x) {
  x[rowSums(is.na(x)) != ncol(x), ]
}
df_srft <- remove_blankr(df_srft)
# Remove columns with empty values in all rows
remove_blankc <- function(x) {
  x[, colSums(is.na(x)) != nrow(x)]
}
df_srft <- remove_blankc(df_srft)
# Set columns classes
df_srft$admission_date <- as.Date(df_srft$admission_date, format = "%d/%m/%Y")
df_srft$surgery_date <- as.Date(df_srft$surgery_date, format = "%d/%m/%Y")
df_srft$discharge_date <- as.Date(df_srft$discharge_date, format = "%d/%m/%Y")
df_srft$date_15 <- as.Date(df_srft$date_15, format = "%d/%m/%Y")
df_srft$date_school <- as.Date(df_srft$date_school, origin = "1899-12-30")
df_srft[] <- lapply(df_srft, function(x) {
  if (class(x) == "Date") {
    dplyr::if_else(lubridate::year(x) < 2018, as.Date(NA), x)
  }
  else {
    (x)
  }
})
df_srft$hospital_stay <- as.numeric(df_srft$hospital_stay)
df_srft$hospital_stay <- ifelse(df_srft$hospital_stay < 0, NA, df_srft$hospital_stay)
df_srft$hb <- as.numeric(df_srft$hb)
df_srft$creatinine <- as.numeric(df_srft$creatinine)
df_srft$albumin <- as.numeric(df_srft$albumin)
df_srft$creatinine_base <- as.numeric(df_srft$creatinine_base)
df_srft$creatinine_high <- as.numeric(df_srft$creatinine_high)
df_srft$tidal_vol <- as.numeric(df_srft$tidal_vol)
df_srft$discharge_loc <- sub("critical care (level 2)", "ccu (level 2)", df_srft$discharge_loc, fixed = TRUE)
df_srft$discharge_loc <- sub("ccu (level 2 and 3)", "ccu (level 2/3)", df_srft$discharge_loc, fixed = TRUE)
df_srft$discharge_loc <- str_replace(df_srft$discharge_loc, "^hdu$", "ccu")
df_srft$anaesthesia <- sapply(strsplit(df_srft$anaesthesia, ",\\s"), `[`, 1)
df_srft$surgeon <- gsub("/", ",", df_srft$surgeon, fixed = TRUE)
df_srft[df_srft$surgeon == "bilal khaffaf", ]$surgeon <- "bilal alkhaffaf"
df_srft[df_srft$area_surgery == "urology", ]$area_surgery <- "urology and endocrinology"
df_srft[df_srft$area_surgery == "nephrology", ]$area_surgery <- "urology and endocrinology"
df_srft[df_srft$area_surgery == "endocrinology", ]$area_surgery <- "urology and endocrinology"
df_srft[df_srft$area_surgery == "head and neck", ]$area_surgery <- "other"
df_srft[df_srft$surgery == "adrenalectomy (unilateral)", ]$surgery <- "adrenalectomy"
df_srft[df_srft$surgery == "anterior resection of rectum", ]$surgery <- "anterior resection"
df_srft[df_srft$surgery == "cystoscopy, stents laparotomy, adhesiolysis, small bowel resection, formation of ileostomy, abdominal wall reconstruction", ]$surgery <- "abdominal wall reconstruction"
df_srft[df_srft$surgery == "gastrectomy (partial / total) with excision of surrounding tissue", ]$surgery <- "gastrectomy (total or partial) with excision of surrounding tissue"
df_srft[df_srft$surgery == "ileo-caecal resection (with anastamosis or ileostomy formation)", ]$surgery <- "ileocaecal resection"
df_srft[df_srft$surgery == "laparoscopic left hemicolectomy", ]$surgery <- "left hemicolectomy (with anastomosis /colostomy)"
df_srft[df_srft$surgery == "laparoscopic left nephrectomy +/- open", ]$surgery <- "nephrectomy (non-transplant)"
df_srft[df_srft$surgery == "left hemicolectomy (with colostomy)", ]$surgery <- "left hemicolectomy (with anastomosis /colostomy)"
df_srft[df_srft$surgery == "left radical laparoscopic nephrectomy", ]$surgery <- "nephrectomy (non-transplant)"
df_srft[df_srft$surgery == "nephrectomy and excision of perirenal tissue", ]$surgery <- "nephrectomy (non-transplant)"
df_srft[df_srft$surgery == "oesophagectomy", ]$surgery <- "oesophagectomy (partial /total)/oesophagogastrectomy"
df_srft[df_srft$surgery == "oesophagectomy (total)/oesophagogastrectomy", ]$surgery <- "oesophagectomy (partial /total)/oesophagogastrectomy"
df_srft[df_srft$surgery == "open gastrectomy", ]$surgery <- "gastrectomy (partial / total) with excision of
surrounding tissue"
df_srft[df_srft$surgery == "laparoscopic right radical nephrectomy", ]$surgery <- "nephrectomy (non-transplant)"
df_srft[df_srft$surgery == "open partial nephrectomy", ]$surgery <- "nephrectomy (non-transplant)"
df_srft[df_srft$surgery == "open right adrenalectomy", ]$surgery <- "adrenalectomy"
df_srft[df_srft$surgery == "open right radical nephrectomy with lymphadenectomy", ]$surgery <- "nephrectomy (non-transplant)"
df_srft[df_srft$surgery == "partial gastrectomy (+/- excision of surrounding tissue)", ]$surgery <- "gastrectomy (partial / total) with excision of
surrounding tissue"
df_srft[df_srft$surgery == "right adrenalectomy", ]$surgery <- "adrenalectomy"
df_srft[df_srft$surgery == "right hemicolectomy (with ileostomy)", ]$surgery <- "right hemicolectomy (with anastomosis /colostomy)"
df_srft[df_srft$surgery == "subtotal gastrectomy", ]$surgery <- "gastrectomy (partial / total) with excision of
surrounding tissue"
df_srft[df_srft$surgery == "gastrectomy (total or partial) with excision of surrounding tissue", ]$surgery <- "gastrectomy (partial / total) with excision of
surrounding tissue"
df_srft$surgery <- sub("\\\n", " ", df_srft$surgery)
df_srft[df_srft$surgery == "right hemicolectomy (with anastamosis)", ]$surgery <- "right hemicolectomy (with anastomosis /colostomy)"
df_srft$tidal_vol <- as.numeric(df_srft$tidal_vol)
df_srft$gastro <- ifelse(!is.na(df_srft$gastro) & df_srft$gastro == "experienced nausea, vomiting or distension, unable to tolerate enteral diet", "unable to tolerate enteral diet, experienced nausea, vomiting or distension", df_srft$gastro)
# 1.3 Transform --------------------------------------------------------------
df_srft <- rename(df_srft, comment_pre = comment) # Change col name and remove cancelled and non elegible patients
df_srft <- df_srft[(!df_srft$comment_pre %in% c("cancelled", "down's syndrome") | is.na(df_srft$comment_pre)) &
  (df_srft$gm_eras_ele != "no" | is.na(df_srft$gm_eras_ele)), ]
df_srft$week_start <- cut.Date(df_srft$surgery_date, breaks = "week") ## week of surgery
df_srft$month_surgery <- format(as.Date(df_srft$surgery_date), "%Y-%m") ## month of surgery
df_srft$discharge_my <- format(as.Date(df_srft$discharge_date), "%Y-%m") ## month of discharge
```

```{r read and clean baseline colorectal dataset, include=FALSE}
df_colorectal <- read_xlsx("./data/colorectal_5_years.xlsx",
  sheet = 2,
  col_types = c(
    "text", "skip", "skip", "date", "date", "text", "text", "skip",
    "numeric", "numeric", "numeric", "numeric", "text"
  ),
  trim_ws = TRUE
)
colnames(df_colorectal) <- c(
  "patient_number", "admission_date", "discharge_date", "opcs_code", "surg_name", "los",
  "readm_30", "mort_30", "mort_90", "cc_stay"
)
df_colorectal[] <- lapply(df_colorectal, function(x)
  if (is.character(x)) {
    tolower(x)
  } else {
    x
  })
df_colorectal$admission_date <- as.Date(df_colorectal$admission_date, format = "%Y-%m-%d")
df_colorectal$discharge_date <- as.Date(df_colorectal$discharge_date, format = "%Y-%m-%d")
df_colorectal$month_adm <- as.Date(cut.Date(df_colorectal$admission_date, breaks = "months"))
df_colorectal$week_adm <- as.Date(cut.Date(df_colorectal$admission_date, breaks = "weeks"))
df_colorectal$week_dis <- as.Date(cut.Date(df_colorectal$discharge_date, breaks = "weeks"))
## add patient identifier
df_colorectal$id <- with(df_colorectal, match(patient_number, unique(patient_number)))
```

```{r merge eras and baseline colorectal, include=FALSE}
double_surg <- df_colorectal %>%  ## Index of entries with same patient undergoing two surgeries on same day
  select(patient_number, admission_date) %>%
  {which(duplicated(.))}
colorectal_merged <- df_srft %>%
  filter(area_surgery == "colorectal" & (eras == "yes" | is.na(eras))) %>% ## eras and colorectal pts
  select(admission_date, discharge_date,
    los = hospital_stay,
    readm_30 = readmit_30, surg_name = surgery
  ) %>% ## only common columns
  mutate(
    baseline = "no",
    readm_30 = if_else(readm_30 == "yes", 1, 0)
  ) %>%
  {
    bind_rows(., df_colorectal %>%
      select(admission_date, discharge_date, los, readm_30, surg_name) %>%
      slice(-double_surg) %>% ## remove double surgeries
      mutate(baseline = "yes"))
  } %>%
  as_tibble()
colorectal_merged <- mutate(colorectal_merged,
  week_adm = as.Date(cut.Date(admission_date, "week")),
  month_adm = format.Date(admission_date, "%Y-%m"),
  month_dis = format.Date(discharge_date, "%Y-%m")
)
```

# Colorectal baseline data
```{r table 1}
knitr::kable(colorectal_merged[sample(nrow(colorectal_merged), 10),],
             caption = "Extract of merged dataset") %>%
  kable_styling(latex_options = c("scale_down", "hold_position"))
```
```{r table 2}
knitr::kable(subset(df_colorectal[sample(nrow(df_colorectal), 10),], select = -c(patient_number, id, month_adm, week_adm, week_dis)),
             caption = "Extract of baseline dataset") %>%
  kable_styling(latex_options = c("scale_down", "hold_position"))
```
```{r table 3}
knitr::kable(df_srft[sample(nrow(df_srft), 10), c("admission_date", "discharge_date", "hospital_stay", "readmit_30", "surgery")], caption = "Extract of ERAS dataset", row.names = F) %>% kable_styling(latex_options = c("scale_down", "hold_position"))
```

The requested historic dataset of colorectal patients at SRFT runs from `r sort(df_colorectal$admission_date)[1]` to `r sort(df_colorectal$admission_date, decreasing=T)[1]`, with `r nrow(df_colorectal)` observations. A few observations share the same patient number and date of admission, meaning that some entries can be different procedures underwent by the same patient on the same day (there are `r sum(duplicated(select(df_colorectal, patient_number, admission_date)))`).
The columns of the dataset are: `r names(df_colorectal)`. `r "cc_stay"` is the number of days of stay in critical care, but is unclear what the value `r "null"` means.
Baseline data contains `r nrow(subset(colorectal_merged, baseline == "yes"))` rows, and ERAS dataset `r nrow(subset(colorectal_merged, baseline == "no"))`. 
\newline
One of the difficulties when merging the ERAS dataset and the historic is the coding of the surgeries. At SRFT, the surgeries are named according to the PQIP list of elegible procedures, and not according to the OPCS coding system. Further work will be committed to renaming colorectal surgeries of ERAS dataset using OPCS coding. This is relevant as it is the only variable in baseline dataset that could be considered predictor of LoS and stay in CC. The ERAS dataset does not capture mortality.

### Summary tables
```{r readm and mortality}
select(df_colorectal, readm_30, mort_90, mort_30, discharge_date) %>%
  mutate(discharge_year = format(discharge_date, "%Y"),
         mort = if_else(mort_90 == 1 | mort_30 == 1, 1, 0)) %>%
  ## some entries got 1 in 30 day mortality, but 0 in 90 day mortality. 90 day mortality doesn't capture mortality within 30 days
  group_by(discharge_year) %>% 
    summarise(total_pts = n(),
              prop_mort = round(sum(mort_90) / n(), 3),
              prop_readm = round(sum(readm_30) / n(), 3)) %>% 
  kable(row.names = FALSE, align = "l", caption = "Incidence of readmission and mortality") %>% 
  kable_styling(latex_options = c("striped", "hold_position"))
```

```{r los fivenum}
select(colorectal_merged, los, discharge_date) %>% 
  mutate(discharge_date = format(discharge_date, "%Y")) %>% 
  group_by(discharge_date) %>% 
  na.omit() %>% 
  group_map(~ {
    .x %>% 
      map_dfc(fivenum) %>% 
      mutate(nms = c("min", "Q1", "median", "Q3", "max"))
    }) %>% 
  spread(nms, los) %>% 
  kable(row.names = FALSE, caption = "Minimum, lower-hinge, median,\nupper-hinge and maximum for LoS by year") %>% 
  kable_styling(latex_options = c("striped", "hold_position"))
  
```

```{r top surgeries}
select(colorectal_merged, surg_name, discharge_date) %>% 
  na.omit() %>% 
  mutate(discharge_date = format(discharge_date, "%Y")) %>% 
  group_by(discharge_date, surg_name) %>% 
  summarise(n = n()) %>% 
  arrange(discharge_date, desc(n)) %>% 
  top_n(5, n) %>% 
  kable(row.names = FALSE, caption = "Five most repeated surgeries per year") %>% 
  kable_styling(latex_options = c("striped", "hold_position"))

```


## Number of colorectal patients by month
```{r pts_month}
colorectal_merged %>%
  group_by(month_adm) %>%
  summarise(n = n(), baseline = if_else(any(baseline == "yes"), "yes", "no")) %>%
  {
    ggplot(., aes(x = .$month_adm, y = .$n, group = 1, colour = baseline)) +
      geom_line() +
      scale_y_continuous(breaks = seq(min(.$n), max(.$n), 3)) +
      scale_x_discrete(breaks = .$month_adm[seq(1, length(.$month_adm), 4)]) +
      annotate("text", x = "2018-04", y = 14, label = "Gap") +
      geom_segment(aes(x = "2018-03", xend = "2018-03", y = 13, yend = 11),
        arrow = arrow(length = unit(0.03, "npc"))
      ) +
      geom_segment(aes(x = "2018-07", xend = "2018-07", y = 13, yend = 11),
        arrow = arrow(length = unit(0.03, "npc"))
      ) +
      theme_fivethirtyeight() +
      theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))
  }
```

Important to note gap in data between 2018-03 and 2018-07. The data collector at SRFT did not start until the end of June of that year. 
\newline
The number of patients a month decreases from 2018-03. It could be that the baseline data includes patients whether they are on a ERAS pathway or not, whereas ERAS dataset excludes patients not on a ERAS protocol. Inclusion criteria at SRFT goes along the list of elegible procedures of PQIP study, which includes all types of colorectal surgeries.   


## Mean and median of LoS grouped by month of discharge (merged dataset)
```{r mean_med_los, warning = TRUE, fig.height = 5}
colorectal_merged %>%
  select(month_dis, los, baseline) %>%
  group_by(month_dis) %>%
  summarise(
    median = median(los, na.rm = TRUE),
    mad = mad(los, na.rm = TRUE),
    mean = mean(los, na.rm = TRUE),
    sd = sd(los, na.rm = TRUE),
    count = n(),
    baseline = if_else(any(baseline == "yes"), "yes", "no")
  ) %>%
  ungroup() %>%
  gather(summary, value, -month_dis, -mad, -sd, -count, -baseline) %>%
  na.omit() %>% ## omit pts with LoS = NA
  {
    ggplot(.) +
      geom_line(aes(x = month_dis, y = value, colour = baseline, group = 1)) +
      scale_x_discrete(
        breaks = unique(.$month_dis)[seq(1, length(.$month_dis), 3)]
      ) +
      scale_y_continuous(
        limits = c(min(.$value), max(.$value)),
        breaks = seq(0, max(.$value), 5)
      ) +
      geom_segment(aes(x = "2018-03", xend = "2018-03", y = 20, yend = 15),
                   arrow = arrow(length = unit(0.03, "npc"))
      ) +
      geom_segment(aes(x = "2018-07", xend = "2018-07", y = 20, yend = 15),
                   arrow = arrow(length = unit(0.03, "npc"))
      ) +
      annotate("text", x = "2018-04", y = 22, label = "Gap") +
      facet_wrap(vars(summary), ncol = 1) +
      theme_fivethirtyeight() +
      theme(axis.text.x = element_text(angle = 45, hjust = 1))
  }
```


## Distribution LoS by year (merged)
```{r histo_los, warning = TRUE, fig.height=12, fig.width=9}
colorectal_merged %>%
  mutate(year_adm = format(admission_date, "%Y")) %>%
  filter(year_adm != "2012") %>% ## exclude single patient in 2012
  group_by(year_adm) %>%
  mutate(median = median(los, na.rm = TRUE)) %>%
  ungroup() %>%
  ggplot(.) +
  geom_histogram(aes(x = los, fill = baseline), binwidth = 1, colour = "gray") +
  scale_x_continuous(breaks = seq(1, 50, 5), limits = c(0, 50)) +
  geom_vline(aes(xintercept = median), linetype = 2) +
  geom_text(aes(x = median, label = paste0("Median: ", median), 
                y = 20, hjust = 0)) +
  theme_fivethirtyeight() +
  theme(text = element_text(size = 15), 
        legend.position = c(.5, .2)) +
  labs(caption = "Note: X axis limited to 50 days\nFirst warning above indicates number of entries left out") +
  facet_wrap(~year_adm, ncol = 3, scales = "free_x")
  
```


## Box plot LoS by month (merged)
```{r boxplot_los, warning = TRUE}
colorectal_merged %>%
  select(month_dis, los, baseline) %>%
  group_by(month_dis) %>%
  na.omit() %>%
  {
    ggplot(.) +
      geom_boxplot(aes(x = month_dis, y = los, colour = baseline)) +
      scale_x_discrete(
        breaks = unique(.$month_dis)[seq(1, length(.$month_dis), 3)]
      ) +
      scale_y_continuous(
        limits = c(0, 40),
        breaks = seq(min(.$los), max(.$los), 5)
      ) + ## maybe change to coord_cartesian(ylim=c(0,40))
      theme_fivethirtyeight() +
      theme(
        axis.text.x = element_text(angle = 45, hjust = 1, size = 11),
        text = element_text(size = 15)
      ) +
      labs(caption = "Note: Y axis limited to 40 days\nFirst warning above indicates number of entries left out")
  }
```

\newpage
## CC stay by year in baseline data
```{r cc_stay, warning = TRUE}
select(df_colorectal, admission_date, cc_stay) %>% 
  mutate(cc_stay = as.integer(replace(cc_stay, cc_stay == "null", 0)),
         year_adm = format(admission_date, "%Y"))  %>% 
  ## assume null cc-stay implies 0 days
  filter(year_adm != "2012") %>% 
  ggplot() +
  geom_histogram(aes(x = cc_stay), binwidth = 1, colour = "grey") +
  geom_vline(aes(xintercept = median(cc_stay)), linetype = 2) +
  scale_x_continuous(limits = c(0, 30), 
                     breaks = c(1:5, seq(5, 30, 5)),
                     labels = c(rep("", 5), seq(5, 30, 5))) +
  scale_y_continuous(limits = c(0, 50)) +
  facet_wrap(~year_adm) +
  theme_fivethirtyeight() +
  theme(plot.caption = element_text(hjust = 1), text = element_text(size = 15)) +
  labs(caption = "Note: X axis limited to 30 days\nFirst warning above indicates number of entries left out")
  
```


## Kaplan-Meier estimations of probability of being in hospital over time since adm
```{r surv_all}
df_surv <- select(colorectal_merged, admission_date, discharge_date, los, baseline) %>%
  mutate(
    discharge = if_else(!is.na(discharge_date), 1, 0),
    ## censoring
    time_event = if_else(is.na(discharge_date), Sys.Date() - admission_date, los),
    ## if not discharged, time from discharge until day of analysis
    year_adm = format(admission_date, "%Y")
  ) %>%
  filter(year_adm != "2012")
  
los_km_year <- survfit(Surv(time = time_event, event = discharge) ~ year_adm, data = df_surv, type = "kaplan-meier")
ggsurvplot(los_km_year,
  surv.median.line = "hv",
  linetype = 1,
  palette = "lancet",
  xlim = c(0, 50),
  break.x.by = 3,
  ggtheme = theme_fivethirtyeight()
)
```

```{r surv_facet}
los_km <- survfit(Surv(time = time_event, event = discharge) ~ baseline, data = df_surv, type = "kaplan-meier")
ggsurvplot(los_km,
  data = df_surv,
  facet.by = "year_adm",
  ncol = 2,
  surv.median.line = "hv",
  conf.int = TRUE,
  linetype = 1,
  palette = "lancet",
  xlim = c(0, 50),  ## note this is similar to coord_cartesian() in ggplot2
  break.x.by = 7,
  ggtheme = theme_fivethirtyeight(),
  legend.title = "",
  legend.labs = c("baseline", "current")
)
```
