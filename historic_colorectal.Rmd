---
title: "Overview of colorectal baseline data"
author: "Pablo M. Rodriguez"
date: "`r format(Sys.Date(), '%d %m %Y')`"
output: 
  pdf_document: 
    highlight: tango
fontsize: 12pt
---

```{r chunk options, include = FALSE}
knitr::opts_chunk$set(tidy = FALSE, echo = FALSE, cache = FALSE, warning = FALSE, message = FALSE)
```

```{r libraries, include = FALSE}
library(tidyverse)
library(lubridate)
library(readxl)
library(survival)
library(survminer)
library(survMisc)
library(stringr)
library(ggthemes)
library(reshape2)
```

```{r read and clean eras dataset, include=FALSE}
# 1.1 Read data ---------------------------------------------------------------
data_path <- list.files("./data", pattern = "\\.csv", full.names = TRUE, ignore.case = TRUE)[[1]] ## save "collated" sheet as a single .csv file and move manually to folder "data"
df_srft <- read.csv(data_path, strip.white = TRUE, stringsAsFactors = FALSE, nrow = 310) ## specify number of rows to read as excel tends to generate blank rows, slowing this step
df_srft[, sapply(df_srft, is.character)] <- sapply(df_srft[, sapply(df_srft, is.character)],
  iconv,
  from = "WINDOWS-1252", to = "UTF-8"
)

# 1.2 Data cleaning -----------------------------------------------------------
df_srft[] <- lapply(df_srft, function(x)
  if (is.character(x) == TRUE) {
    tolower(x)
  } else {
    x
  })

df_srft[] <- lapply(df_srft, function(x)
  if (is.character(x) == TRUE) {
    trimws(x)
  } else {
    x
  })

# Replace not recorded and missing values with NAs (to be discussed)
na_list <- c(
  0, "0", "", "NA", "na", "n/a", "<NA>", "not known/not recorded", "n/r",
  "not measured", "Not Measured", "none measured", "None Measured", "not done", "Not Done",
  "n/d", "Not Recorded", "not recorded", "u/k", "unknown", "#ref!"
)
df_srft[] <- lapply(df_srft, function(x) ifelse(x %in% na_list, NA, x))

# Remove rows with empty values in all columns
remove_blankr <- function(x) {
  x[rowSums(is.na(x)) != ncol(x), ]
}

df_srft <- remove_blankr(df_srft)

# Remove columns with empty values in all rows
remove_blankc <- function(x) {
  x[, colSums(is.na(x)) != nrow(x)]
}

df_srft <- remove_blankc(df_srft)

# Set columns classes
df_srft$admission_date <- as.Date(df_srft$admission_date, format = "%d/%m/%Y")

df_srft$surgery_date <- as.Date(df_srft$surgery_date, format = "%d/%m/%Y")

df_srft$discharge_date <- as.Date(df_srft$discharge_date, format = "%d/%m/%Y")

df_srft$date_15 <- as.Date(df_srft$date_15, format = "%d/%m/%Y")

df_srft$date_school <- as.Date(df_srft$date_school, origin = "1899-12-30")

df_srft[] <- lapply(df_srft, function(x) {
  if (class(x) == "Date") {
    dplyr::if_else(lubridate::year(x) < 2018, as.Date(NA), x)
  }
  else {
    (x)
  }
})

df_srft$hospital_stay <- as.numeric(df_srft$hospital_stay)
df_srft$hospital_stay <- ifelse(df_srft$hospital_stay < 0, NA, df_srft$hospital_stay)

df_srft$hb <- as.numeric(df_srft$hb)
df_srft$creatinine <- as.numeric(df_srft$creatinine)
df_srft$albumin <- as.numeric(df_srft$albumin)
df_srft$creatinine_base <- as.numeric(df_srft$creatinine_base)
df_srft$creatinine_high <- as.numeric(df_srft$creatinine_high)
df_srft$tidal_vol <- as.numeric(df_srft$tidal_vol)

df_srft$discharge_loc <- sub("critical care (level 2)", "ccu (level 2)", df_srft$discharge_loc, fixed = TRUE)
df_srft$discharge_loc <- sub("ccu (level 2 and 3)", "ccu (level 2/3)", df_srft$discharge_loc, fixed = TRUE)
df_srft$discharge_loc <- str_replace(df_srft$discharge_loc, "^hdu$", "ccu")

df_srft$anaesthesia <- sapply(strsplit(df_srft$anaesthesia, ",\\s"), `[`, 1)

df_srft$surgeon <- gsub("/", ",", df_srft$surgeon, fixed = TRUE)
df_srft[df_srft$surgeon == "bilal khaffaf", ]$surgeon <- "bilal alkhaffaf"

df_srft[df_srft$area_surgery == "urology", ]$area_surgery <- "urology and endocrinology"
df_srft[df_srft$area_surgery == "nephrology", ]$area_surgery <- "urology and endocrinology"
df_srft[df_srft$area_surgery == "endocrinology", ]$area_surgery <- "urology and endocrinology"
df_srft[df_srft$area_surgery == "head and neck", ]$area_surgery <- "other"

df_srft[df_srft$surgery == "adrenalectomy (unilateral)", ]$surgery <- "adrenalectomy"
df_srft[df_srft$surgery == "anterior resection of rectum", ]$surgery <- "anterior resection"
df_srft[df_srft$surgery == "cystoscopy, stents laparotomy, adhesiolysis, small bowel resection, formation of ileostomy, abdominal wall reconstruction", ]$surgery <- "abdominal wall reconstruction"
df_srft[df_srft$surgery == "gastrectomy (partial / total) with excision of surrounding tissue", ]$surgery <- "gastrectomy (total or partial) with excision of surrounding tissue"
df_srft[df_srft$surgery == "ileo-caecal resection (with anastamosis or ileostomy formation)", ]$surgery <- "ileocaecal resection"
df_srft[df_srft$surgery == "laparoscopic left hemicolectomy", ]$surgery <- "left hemicolectomy (with anastomosis /colostomy)"
df_srft[df_srft$surgery == "laparoscopic left nephrectomy +/- open", ]$surgery <- "nephrectomy (non-transplant)"
df_srft[df_srft$surgery == "left hemicolectomy (with colostomy)", ]$surgery <- "left hemicolectomy (with anastomosis /colostomy)"
df_srft[df_srft$surgery == "left radical laparoscopic nephrectomy", ]$surgery <- "nephrectomy (non-transplant)"
df_srft[df_srft$surgery == "nephrectomy and excision of perirenal tissue", ]$surgery <- "nephrectomy (non-transplant)"
df_srft[df_srft$surgery == "oesophagectomy", ]$surgery <- "oesophagectomy (partial /total)/oesophagogastrectomy"
df_srft[df_srft$surgery == "oesophagectomy (total)/oesophagogastrectomy", ]$surgery <- "oesophagectomy (partial /total)/oesophagogastrectomy"
df_srft[df_srft$surgery == "open gastrectomy", ]$surgery <- "gastrectomy (partial / total) with excision of
surrounding tissue"
df_srft[df_srft$surgery == "laparoscopic right radical nephrectomy", ]$surgery <- "nephrectomy (non-transplant)"
df_srft[df_srft$surgery == "open partial nephrectomy", ]$surgery <- "nephrectomy (non-transplant)"
df_srft[df_srft$surgery == "open right adrenalectomy", ]$surgery <- "adrenalectomy"
df_srft[df_srft$surgery == "open right radical nephrectomy with lymphadenectomy", ]$surgery <- "nephrectomy (non-transplant)"
df_srft[df_srft$surgery == "partial gastrectomy (+/- excision of surrounding tissue)", ]$surgery <- "gastrectomy (partial / total) with excision of
surrounding tissue"
df_srft[df_srft$surgery == "right adrenalectomy", ]$surgery <- "adrenalectomy"
df_srft[df_srft$surgery == "right hemicolectomy (with ileostomy)", ]$surgery <- "right hemicolectomy (with anastomosis /colostomy)"
df_srft[df_srft$surgery == "subtotal gastrectomy", ]$surgery <- "gastrectomy (partial / total) with excision of
surrounding tissue"
df_srft[df_srft$surgery == "gastrectomy (total or partial) with excision of surrounding tissue", ]$surgery <- "gastrectomy (partial / total) with excision of
surrounding tissue"
df_srft$surgery <- sub("\\\n", " ", df_srft$surgery)
df_srft[df_srft$surgery == "right hemicolectomy (with anastamosis)", ]$surgery <- "right hemicolectomy (with anastomosis /colostomy)"

df_srft$tidal_vol <- as.numeric(df_srft$tidal_vol)

df_srft$gastro <- ifelse(!is.na(df_srft$gastro) & df_srft$gastro == "experienced nausea, vomiting or distension, unable to tolerate enteral diet", "unable to tolerate enteral diet, experienced nausea, vomiting or distension", df_srft$gastro)

# 1.3 Transform --------------------------------------------------------------
df_srft <- rename(df_srft, comment_pre = comment) # Change col name and remove cancelled and non elegible patients
df_srft <- df_srft[(!df_srft$comment_pre %in% c("cancelled", "down's syndrome") | is.na(df_srft$comment_pre)) &
  (df_srft$gm_eras_ele != "no" | is.na(df_srft$gm_eras_ele)), ]
df_srft$week_start <- cut.Date(df_srft$surgery_date, breaks = "week") ## week of surgery
df_srft$month_surgery <- format(as.Date(df_srft$surgery_date), "%Y-%m") ## month of surgery
df_srft$discharge_my <- format(as.Date(df_srft$discharge_date), "%Y-%m") ## month of discharge



```

```{r read and clean baseline colorectal dataset, include=FALSE}
df_colorectal <- read_xlsx("./data/colorectal_5_years.xlsx",
  sheet = 2,
  col_types = c(
    "text", "skip", "skip", "date", "date", "text", "text", "skip",
    "numeric", "numeric", "numeric", "numeric", "text"
  ),
  trim_ws = TRUE
)

colnames(df_colorectal) <- c(
  "patient_number", "admission_date", "discharge_date", "opcs_code", "surg_name", "los",
  "readm_30", "mort_30", "mort_90", "cc_stay"
)

df_colorectal[] <- lapply(df_colorectal, function(x)
  if (is.character(x)) {
    tolower(x)
  } else {
    x
  })

df_colorectal$admission_date <- as.Date(df_colorectal$admission_date, format = "%Y-%m-%d")
df_colorectal$discharge_date <- as.Date(df_colorectal$discharge_date, format = "%Y-%m-%d")
df_colorectal$month_adm <- as.Date(cut.Date(df_colorectal$admission_date, breaks = "months"))
df_colorectal$week_adm <- as.Date(cut.Date(df_colorectal$admission_date, breaks = "weeks"))
df_colorectal$week_dis <- as.Date(cut.Date(df_colorectal$discharge_date, breaks = "weeks"))

## add patient identifier
df_colorectal$id <- with(df_colorectal, match(patient_number, unique(patient_number)))

```

```{r merge eras and baseline colorectal, include=FALSE}
double_surg <- df_colorectal %>%  ## Index of entries with same patient undergoing two surgeries on same day
  select(patient_number, admission_date) %>%
  {
    which(duplicated(.))
  }


colorectal_merged <- df_srft %>%
  filter(area_surgery == "colorectal" & (eras == "yes" | is.na(eras))) %>% ## eras and colorectal pts
  select(admission_date, discharge_date,
    los = hospital_stay,
    readm_30 = readmit_30, surg_name = surgery
  ) %>% ## only common columns
  mutate(
    baseline = "no"
  ) %>%
  {
    bind_rows(., df_colorectal %>%
      select(admission_date, discharge_date, los, readm_30, surg_name) %>%
      slice(-double_surg) %>% ## remove double surgeries
      mutate(baseline = "yes", readm_30 = if_else(readm_30 == 1, "yes", "no")))
  } %>%
  as_tibble()

colorectal_merged <- mutate(colorectal_merged,
  week_adm = as.Date(cut.Date(admission_date, "week")),
  month_adm = format.Date(admission_date, "%Y-%m"),
  month_dis = format.Date(discharge_date, "%Y-%m")
)
```

# Colorectal baseline data
The requested historic dataset of colorectal patients at SRFT runs from `r sort(df_colorectal$admission_date)[1]` to `r sort(df_colorectal$admission_date, decreasing=T)[1]`, with `r nrow(df_colorectal)` observations. A few observations share the same patient number and date of admission, meaning that some entries can be different procedures underwent by the same patient on the same day (there are `r sum(duplicated(select(df_colorectal, patient_number, admission_date)))`).
The columns of the dataset are: `r names(df_colorectal)`. `r "cc_stay"` is the number of days of stay in critical care, but is unclear what the value `r "null"` means. 
\newline
\newline
One of the difficulties when merging the ERAS dataset and the historic is the coding of the surgeries. At SRFT, the surgeries are named according to the PQIP list of elegible procedures, and not according to the OPCS coding system. Further work will be committed to renaming colorectal surgeries of ERAS dataset using OPCS coding. This is important as it is the only variable in baseline dataset that could be considered predictor of LoS and stay in CC.

## Number of colorectal patients by month
```{r pts_month}
colorectal_merged %>%
  group_by(month_adm) %>%
  summarise(n = n(), baseline = if_else(any(baseline == "yes"), "yes", "no")) %>%
  {
    ggplot(., aes(x = .$month_adm, y = .$n, group = 1, colour = baseline)) +
      geom_line() +
      scale_y_continuous(breaks = seq(min(.$n), max(.$n), 3)) +
      scale_x_discrete(breaks = .$month_adm[seq(1, length(.$month_adm), 4)]) +
      annotate("text", x = "2018-04", y = 14, label = "Gap") +
      geom_segment(aes(x = "2018-03", xend = "2018-03", y = 13, yend = 11),
        arrow = arrow(length = unit(0.03, "npc"))
      ) +
      geom_segment(aes(x = "2018-07", xend = "2018-07", y = 13, yend = 11),
        arrow = arrow(length = unit(0.03, "npc"))
      ) +
      theme_fivethirtyeight() +
      theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))
  }
```

Important to note gap in data between 2018-03 and 2018-07. The data collector at SRFT did not start until the end of June of that year. 
\newline
The number of patients a month decreases from 2018-03. It could be that the baseline data includes patients whether they are on a ERAS pathway or not, whereas ERAS dataset excludes patients not on a ERAS protocol.  

## Mean and median of LoS grouped by month of discharge
```{r mean_med_los, warning = TRUE, fig.height = 5}
colorectal_merged %>%
  select(month_dis, los, baseline) %>%
  group_by(month_dis) %>%
  summarise(
    median = median(los, na.rm = TRUE),
    mad = mad(los, na.rm = TRUE),
    mean = mean(los, na.rm = TRUE),
    sd = sd(los, na.rm = TRUE),
    count = n(),
    baseline = if_else(any(baseline == "yes"), "yes", "no")
  ) %>%
  ungroup() %>%
  gather(summary, value, -month_dis, -mad, -sd, -count, -baseline) %>%
  na.omit() %>% ## omit pts with LoS = NA
  {
    ggplot(.) +
      geom_line(aes(x = month_dis, y = value, colour = baseline, group = 1)) +
      scale_x_discrete(
        breaks = unique(.$month_dis)[seq(1, length(.$month_dis), 3)]
      ) +
      scale_y_continuous(
        limits = c(min(.$value), max(.$value)),
        breaks = seq(0, max(.$value), 5)
      ) +
      geom_segment(aes(x = "2018-03", xend = "2018-03", y = 20, yend = 15),
                   arrow = arrow(length = unit(0.03, "npc"))
      ) +
      geom_segment(aes(x = "2018-07", xend = "2018-07", y = 20, yend = 15),
                   arrow = arrow(length = unit(0.03, "npc"))
      ) +
      annotate("text", x = "2018-04", y = 22, label = "Gap") +
      facet_wrap(vars(summary), ncol = 1) +
      theme_fivethirtyeight() +
      theme(axis.text.x = element_text(angle = 45, hjust = 1))
  }
```


## Box plot LoS by month
```{r boxplot_los, warning = TRUE}
colorectal_merged %>%
  select(month_dis, los, baseline) %>%
  group_by(month_dis) %>%
  na.omit() %>%
  {
    ggplot(.) +
      geom_boxplot(aes(x = month_dis, y = los, colour = baseline)) +
      scale_x_discrete(
        breaks = unique(.$month_dis)[seq(1, length(.$month_dis), 3)]
      ) +
      scale_y_continuous(
        # limits = c(0, 96),
        breaks = seq(min(.$los), max(.$los), 20)
      ) + ## change interactively if want to keep all observations
      theme_fivethirtyeight() +
      theme(axis.text.x = element_text(angle = 45, hjust = 1))
  }
```

