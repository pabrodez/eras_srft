---
title: "Oesophagectomies baseline data at SRFT"
subtitle: "Data processing documentation"
author: "Pablo M. Rodriguez"
date: "`r Sys.Date()`"
output: 
  tufte::tufte_html: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(tidy = FALSE, echo = TRUE, cache = FALSE, warning = FALSE, message = FALSE)
options(htmltools.dir.version = FALSE)
```
```{r libraries, include=FALSE}
library(tidyverse)
library(lubridate)
library(readxl)
library(survival)
library(survminer)
library(survMisc)
library(stringr)
library(ggthemes)
library(reshape2)
library(knitr)
library(kableExtra)
library(gridExtra)
library(survival)
library(survminer)
library(kableExtra)
library(knitr)
library(tint)
library(tufte)
library(scales)
```
```{r read and clean eras dataset, include=FALSE}
# 1.1 Read ---------------------------------------------------------------
# save "collated" sheet as a single .csv file and move manually to folder "data"
df_srft <- read.csv("./data/eras_srft.csv", strip.white = TRUE, stringsAsFactors = FALSE, nrow = 310) ## specify number of rows to read as excel tends to generate blank rows, slowing this step
df_srft[, sapply(df_srft, is.character)] <- sapply(df_srft[, sapply(df_srft, is.character)],
  iconv,
  from = "WINDOWS-1252", to = "UTF-8"
)
# 1.2 Clean -----------------------------------------------------------
df_srft[] <- lapply(df_srft, function(x)
  if (is.character(x) == TRUE) {
    tolower(x)
  } else {
    x
  })
df_srft[] <- lapply(df_srft, function(x)
  if (is.character(x) == TRUE) {
    trimws(x)
  } else {
    x
  })
# Replace not recorded and missing values with NAs (to be discussed)
na_list <- c(
  0, "0", "", "NA", "na", "n/a", "<NA>", "not known/not recorded", "n/r",
  "not measured", "Not Measured", "none measured", "None Measured", "not done", "Not Done",
  "n/d", "Not Recorded", "not recorded", "u/k", "unknown", "#ref!"
)
df_srft[] <- lapply(df_srft, function(x) ifelse(x %in% na_list, NA, x))
# Remove rows with empty values in all columns
remove_blankr <- function(x) {
  x[rowSums(is.na(x)) != ncol(x), ]
}
df_srft <- remove_blankr(df_srft)
# Remove columns with empty values in all rows
remove_blankc <- function(x) {
  x[, colSums(is.na(x)) != nrow(x)]
}
df_srft <- remove_blankc(df_srft)
# Set columns classes
df_srft$admission_date <- as.Date(df_srft$admission_date, format = "%d/%m/%Y")
df_srft$surgery_date <- as.Date(df_srft$surgery_date, format = "%d/%m/%Y")
df_srft$discharge_date <- as.Date(df_srft$discharge_date, format = "%d/%m/%Y")
df_srft$date_15 <- as.Date(df_srft$date_15, format = "%d/%m/%Y")
df_srft$date_school <- as.Date(df_srft$date_school, origin = "1899-12-30")
df_srft[] <- lapply(df_srft, function(x) {
  if (class(x) == "Date") {
    dplyr::if_else(lubridate::year(x) < 2018, as.Date(NA), x)
  }
  else {
    (x)
  }
})
df_srft$hospital_stay <- as.numeric(df_srft$hospital_stay)
df_srft$hospital_stay <- ifelse(df_srft$hospital_stay < 0, NA, df_srft$hospital_stay)
df_srft$hb <- as.numeric(df_srft$hb)
df_srft$creatinine <- as.numeric(df_srft$creatinine)
df_srft$albumin <- as.numeric(df_srft$albumin)
df_srft$creatinine_base <- as.numeric(df_srft$creatinine_base)
df_srft$creatinine_high <- as.numeric(df_srft$creatinine_high)
df_srft$tidal_vol <- as.numeric(df_srft$tidal_vol)
df_srft$discharge_loc <- sub("critical care (level 2)", "ccu (level 2)", df_srft$discharge_loc, fixed = TRUE)
df_srft$discharge_loc <- sub("ccu (level 2 and 3)", "ccu (level 2/3)", df_srft$discharge_loc, fixed = TRUE)
df_srft$discharge_loc <- str_replace(df_srft$discharge_loc, "^hdu$", "ccu")
df_srft$anaesthesia <- sapply(strsplit(df_srft$anaesthesia, ",\\s"), `[`, 1)
df_srft$surgeon <- gsub("/", ",", df_srft$surgeon, fixed = TRUE)
df_srft[df_srft$surgeon == "bilal khaffaf", ]$surgeon <- "bilal alkhaffaf"
df_srft[df_srft$area_surgery == "urology", ]$area_surgery <- "urology and endocrinology"
df_srft[df_srft$area_surgery == "nephrology", ]$area_surgery <- "urology and endocrinology"
df_srft[df_srft$area_surgery == "endocrinology", ]$area_surgery <- "urology and endocrinology"
df_srft[df_srft$area_surgery == "head and neck", ]$area_surgery <- "other"
df_srft[df_srft$surgery == "adrenalectomy (unilateral)", ]$surgery <- "adrenalectomy"
df_srft[df_srft$surgery == "anterior resection of rectum", ]$surgery <- "anterior resection"
df_srft[df_srft$surgery == "cystoscopy, stents laparotomy, adhesiolysis, small bowel resection, formation of ileostomy, abdominal wall reconstruction", ]$surgery <- "abdominal wall reconstruction"
df_srft[df_srft$surgery == "gastrectomy (partial / total) with excision of surrounding tissue", ]$surgery <- "gastrectomy (total or partial) with excision of surrounding tissue"
df_srft[df_srft$surgery == "ileo-caecal resection (with anastamosis or ileostomy formation)", ]$surgery <- "ileocaecal resection"
df_srft[df_srft$surgery == "laparoscopic left hemicolectomy", ]$surgery <- "left hemicolectomy (with anastomosis /colostomy)"
df_srft[df_srft$surgery == "laparoscopic left nephrectomy +/- open", ]$surgery <- "nephrectomy (non-transplant)"
df_srft[df_srft$surgery == "left hemicolectomy (with colostomy)", ]$surgery <- "left hemicolectomy (with anastomosis /colostomy)"
df_srft[df_srft$surgery == "left radical laparoscopic nephrectomy", ]$surgery <- "nephrectomy (non-transplant)"
df_srft[df_srft$surgery == "nephrectomy and excision of perirenal tissue", ]$surgery <- "nephrectomy (non-transplant)"
df_srft[df_srft$surgery == "oesophagectomy", ]$surgery <- "oesophagectomy (partial /total)/oesophagogastrectomy"
df_srft[df_srft$surgery == "oesophagectomy (total)/oesophagogastrectomy", ]$surgery <- "oesophagectomy (partial /total)/oesophagogastrectomy"
df_srft[df_srft$surgery == "open gastrectomy", ]$surgery <- "gastrectomy (partial / total) with excision of
surrounding tissue"
df_srft[df_srft$surgery == "laparoscopic right radical nephrectomy", ]$surgery <- "nephrectomy (non-transplant)"
df_srft[df_srft$surgery == "open partial nephrectomy", ]$surgery <- "nephrectomy (non-transplant)"
df_srft[df_srft$surgery == "open right adrenalectomy", ]$surgery <- "adrenalectomy"
df_srft[df_srft$surgery == "open right radical nephrectomy with lymphadenectomy", ]$surgery <- "nephrectomy (non-transplant)"
df_srft[df_srft$surgery == "partial gastrectomy (+/- excision of surrounding tissue)", ]$surgery <- "gastrectomy (partial / total) with excision of
surrounding tissue"
df_srft[df_srft$surgery == "right adrenalectomy", ]$surgery <- "adrenalectomy"
df_srft[df_srft$surgery == "right hemicolectomy (with ileostomy)", ]$surgery <- "right hemicolectomy (with anastomosis /colostomy)"
df_srft[df_srft$surgery == "subtotal gastrectomy", ]$surgery <- "gastrectomy (partial / total) with excision of
surrounding tissue"
df_srft[df_srft$surgery == "gastrectomy (total or partial) with excision of surrounding tissue", ]$surgery <- "gastrectomy (partial / total) with excision of
surrounding tissue"
df_srft$surgery <- sub("\\\n", " ", df_srft$surgery)
df_srft[df_srft$surgery == "right hemicolectomy (with anastamosis)", ]$surgery <- "right hemicolectomy (with anastomosis /colostomy)"
df_srft$tidal_vol <- as.numeric(df_srft$tidal_vol)
df_srft$gastro <- ifelse(!is.na(df_srft$gastro) & df_srft$gastro == "experienced nausea, vomiting or distension, unable to tolerate enteral diet", "unable to tolerate enteral diet, experienced nausea, vomiting or distension", df_srft$gastro)
# 1.3 Transform --------------------------------------------------------------
df_srft <- rename(df_srft, comment_pre = comment) # Change col name and remove cancelled and non elegible patients
df_srft <- df_srft[(!df_srft$comment_pre %in% c("cancelled", "down's syndrome") | is.na(df_srft$comment_pre)) &
  (df_srft$gm_eras_ele != "no" | is.na(df_srft$gm_eras_ele)), ]
df_srft$week_start <- cut.Date(df_srft$surgery_date, breaks = "week") ## week of surgery
df_srft$month_surgery <- format(as.Date(df_srft$surgery_date), "%Y-%m") ## month of surgery
df_srft$discharge_my <- format(as.Date(df_srft$discharge_date), "%Y-%m") ## month of discharge
```

# Oesophagectomies baseline data
The purpose of this document is to record the preparation of oesophagectomies baseline data.
\newline
R software for data handling and formatting, and Rmarkdown for text composition were used.
\newline
This document is structured step-wise: From data import to visualization, via data cleaning. Most steps are shown along the chunk of code from the whole script. Code is omitted to avoid repetition, when necessary.
\newline
The data processing of the eras dataset is not documented here because of its length. It can befound [here](https://github.com/pabrodez/eras_srft/blob/master/script.R)
\newline 
The underlying aim is to enhance transparency, which subsequently eases criticism and improvement.

## Data import
Baseline data was provided in .ppt format. It was manually converted to .csv to ease import.
`r tint::margin_note("Import, set column types and names")`
```{r read}
df_oeso <- read.csv("./data/ppt_oesophagectomies.csv",
  colClasses = c("character", "character", "character", "character", "character", "character"),
  na.strings = c("n/a", "NA"),
  col.names = c("op_date", "pneumonia", "oxygen", "ventilated", "abx", "notes")
)
```

`r tint::margin_note("Format date column and substitue values accordingly")`
```{r date, echo=TRUE}
# df_oeso$op_date <- as.Date(df_oeso$op_date, "%d/%m/%Y")

df_oeso <- df_oeso %>%
  select(pneumonia:abx) %>%
  map_dfc(~ if_else(.x == "1", "yes", "no", NA_character_)) %>%
  {
    cbind(., select(df_oeso, -one_of(colnames(.))))
  }

```

## Summary 
```{r table_head}
head(df_oeso, 5) %>% 
  kable(., caption = "Extract of dataset")
```

```{r set_theme, include=FALSE}
theme_session <- theme_bw() + theme(
  plot.background = element_rect(fill = "#fffff8"), 
  legend.background = element_rect(fill = "#fffff8"),
  panel.background = element_rect(fill = "#fffff8")
)
theme_set(theme_session)

```

### Patients with pneumonia
```{r pneumo_hist, echo=FALSE, fig.margin=TRUE}
df_oeso %>%
  ggplot(.) +
  geom_bar(aes(x = pneumonia))
  
```
```{r pneumo_table}
table(Pneumonia = df_oeso$pneumonia, useNA = "ifany") %>% 
  kable(.) 

```

### New requirement for oxygen therapy
```{r oxy_hist, echo=FALSE, fig.margin=TRUE}
df_oeso %>%
  ggplot(.) +
  geom_bar(aes(x = oxygen)) +
  scale_y_continuous(breaks= pretty_breaks())
  
```
```{r oxy_table, echo=FALSE}
table(Oxygen = df_oeso$oxygen, useNA = "ifany") %>% 
  kable(.) 

```

### New requirement for ventilation
```{r vent_hist, echo=FALSE, fig.margin=TRUE}
df_oeso %>%
  ggplot(.) +
  geom_bar(aes(x = ventilated))
  
```
```{r vent_table, echo=FALSE}
table(Ventilation = df_oeso$ventilation, useNA = "ifany") %>% 
  kable(.) 

```

### Need for IV antibiotics
```{r abx_hist, echo=FALSE, fig.margin=TRUE}
df_oeso %>%
  ggplot(.) +
  geom_bar(aes(x = abx))
  
```
```{r abx_table, echo=FALSE}
table(Abx = df_oeso$abx, useNA = "ifany") %>% 
  kable(.) 

```

### Need for IV antibiotics
```{r abx_hist, echo=FALSE, fig.margin=TRUE}
df_oeso %>%
  ggplot(.) +
  geom_bar(aes(x = abx))
  
```
```{r abx_table, echo=FALSE}
table(Abx = df_oeso$abx, useNA = "ifany") %>% 
  kable(.) 

```

### Need for IV antibiotics
```{r abx_hist, echo=FALSE, fig.margin=TRUE}
df_oeso %>%
  ggplot(.) +
  geom_bar(aes(x = abx))
  
```
```{r abx_table, echo=FALSE}
table(Abx = df_oeso$abx, useNA = "ifany") %>% 
  kable(.) 

```





